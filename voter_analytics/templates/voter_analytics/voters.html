{% extends 'voter_analytics/base.html' %}

{% block title %}Newton Voters - Voter Analytics{% endblock %}

{% block content %}
    <h1>Newton Voter Analytics</h1>

    <!-- Filter Form -->
    <div class="filter-form">
        <h2>Filter Voters</h2>
        <form method="get" action="{% url 'voters' %}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="party">Party Affiliation:</label>
                    <select name="party" id="party">
                        <option value="">All Parties</option>
                        {% for party in parties %}
                        <option value="{{ party }}" {% if selected_party == party %}selected{% endif %}>
                            {{ party }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="min_birth_year">Minimum Birth Year:</label>
                    <select name="min_birth_year" id="min_birth_year">
                        <option value="">Any Year</option>
                        {% for year in years %}
                        <option value="{{ year }}" {% if selected_min_year == year|stringformat:"s" %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="max_birth_year">Maximum Birth Year:</label>
                    <select name="max_birth_year" id="max_birth_year">
                        <option value="">Any Year</option>
                        {% for year in years %}
                        <option value="{{ year }}" {% if selected_max_year == year|stringformat:"s" %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="voter_score">Voter Score:</label>
                    <select name="voter_score" id="voter_score">
                        <option value="">Any Score</option>
                        {% for score in voter_scores %}
                        <option value="{{ score }}" {% if selected_voter_score == score|stringformat:"s" %}selected{% endif %}>
                            {{ score }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-group">
                <label>Voted in Elections:</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" name="v20state" id="v20state" value="TRUE" 
                               {% if checked_v20state %}checked{% endif %}>
                        <label for="v20state">2020 State Election</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="v21town" id="v21town" value="TRUE"
                               {% if checked_v21town %}checked{% endif %}>
                        <label for="v21town">2021 Town Election</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="v21primary" id="v21primary" value="TRUE"
                               {% if checked_v21primary %}checked{% endif %}>
                        <label for="v21primary">2021 Primary</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="v22general" id="v22general" value="TRUE"
                               {% if checked_v22general %}checked{% endif %}>
                        <label for="v22general">2022 General Election</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="v23town" id="v23town" value="TRUE"
                               {% if checked_v23town %}checked{% endif %}>
                        <label for="v23town">2023 Town Election</label>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit">Apply Filters</button>
                <a href="{% url 'voters' %}" class="reset-button">Clear Filters</a>
            </div>
        </form>
    </div>

    <!-- Results Information -->
    <div class="results-info">
        <strong>Showing {{ voters|length }} voter(s) on this page</strong>
        {% if page_obj %}
            (Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}, 
            Total: {{ page_obj.paginator.count }} voters)
        {% endif %}
    </div>

    <!-- Voter Table -->
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Street Address</th>
                <th>Date of Birth</th>
                <th>Party</th>
                <th>Voter Score</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for voter in voters %}
            <tr>
                <td>{{ voter.first_name }} {{ voter.last_name }}</td>
                <td>{{ voter.street_number }} {{ voter.street_name }}
                    {% if voter.apartment_number %}
                        Apt {{ voter.apartment_number }}
                    {% endif %}
                </td>
                <td>{{ voter.DOB|date:"m/d/Y" }}</td>
                <td>{{ voter.party }}</td>
                <td>{{ voter.voter_score }}</td>
                <td><a href="{% url 'voter' voter.pk %}">View Details</a></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 20px;">
                    No voters found matching the selected criteria.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if page_obj %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}